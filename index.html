<html><head><base href="." />
<title>JustCord - Simple Chat Platform</title>
<style>
:root {
  --bg-primary: #36393f;
  --bg-secondary: #2f3136;
  --bg-tertiary: #202225;
  --text-primary: #dcddde;
  --text-secondary: #72767d;
  --accent: #7289da;
  --red: #ed4245;
}

body, html {
  margin: 0;
  padding: 0;
  font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
}

.container {
  display: grid;
  grid-template-columns: 72px 240px 1fr;
  height: 100vh;
}

.servers {
  background: var(--bg-tertiary);
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  overflow-y: auto;
  max-height: calc(100vh - 60px);
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--bg-tertiary);
}

.servers::-webkit-scrollbar {
  width: 6px;
}

.servers::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
}

.servers::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

.server-icon {
  width: 48px;
  height: 48px;
  background: var(--bg-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-radius 0.2s;
  color: var(--accent);
}

.server-icon.custom-icon {
  background-size: cover;
  background-position: center;
  color: transparent;
}

.server-icon:hover {
  border-radius: 16px;
  background: var(--accent);
  color: white;
}

.server-icon.add {
  opacity: 0.8;
  transition: opacity 0.2s;
}

.server-icon.add:hover {
  opacity: 1;
  background: #3ba55d;
}

.channels {
  background: var(--bg-secondary);
  padding: 12px;
  overflow-y: auto;
}

.channels h3 {
  margin-top: 0;
  margin-bottom: 16px;
  color: var(--text-secondary);
}

.online-user {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  border-radius: 4px;
  margin-bottom: 4px;
}

.online-user:hover {
  background: rgba(79, 84, 92, 0.16);
}

.status {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #3ba55d;
}

.chat {
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  position: relative;
  height: 100vh;
  overflow: hidden;
  grid-column: 3;
}

.messages {
  flex: 1;
  padding: 16px;
  padding-bottom: 80px;
  overflow-y: auto;
  height: calc(100vh - 140px);
  margin-bottom: 60px;
}

.message {
  margin-bottom: 16px;
  display: flex;
  gap: 12px;
}

.message.justai .username {
  color: #ffae42;
}

.message.justai.typing .message-text {
  font-style: italic;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-secondary);
}

.message-content {
  flex: 1;
}

.message-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.username {
  font-weight: 500;
  color: white;
}

.timestamp {
  color: var(--text-secondary);
  font-size: 0.75rem;
}

.message-actions {
  visibility: hidden;
  margin-left: auto;
  display: flex;
  gap: 4px;
}

.message:hover .message-actions {
  visibility: visible;
}

.reply-btn, .delete-btn {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: color 0.2s, background 0.2s;
}

.reply-btn:hover, .delete-btn:hover {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
}

.reply-preview {
  background: var(--bg-secondary);
  padding: 8px;
  border-left: 4px solid var(--accent);
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.reply-preview span {
  color: var(--text-secondary);
}

.cancel-reply-btn {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 16px;
}

.delete-btn {
  background: none;
  border: none;
  color: var(--red);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
}

.delete-btn:hover {
  background: rgba(237, 66, 69, 0.1);
}

.input-area {
  padding: 16px;
  position: fixed;
  bottom: 0;
  left: 312px; 
  right: 0;
  background: var(--bg-primary);
  border-top: 1px solid rgba(79, 84, 92, 0.48);
  z-index: 10;
}

.input-wrapper {
  display: flex;
  gap: 8px;
  align-items: center;
}

.upload-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-btn:hover {
  opacity: 0.9;
}

.message-input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  background: #40444b;
  border: none;
  color: var(--text-primary);
  font-size: 1rem;
  outline: none;
}

.message-input::placeholder {
  color: var(--text-secondary);
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

.server-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 8px;
  z-index: 1000;
}

.server-modal .preview-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin: 10px auto;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  cursor: pointer;
  transition: border-radius 0.2s;
}

.server-modal .preview-icon:hover {
  border-radius: 16px;
}

.server-modal .upload-hint {
  text-align: center;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.modal-input {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  background: var(--bg-primary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
}

.modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.modal-button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.modal-button.create {
  background: var(--accent);
  color: white;
}

.modal-button.cancel {
  background: var(--red);
  color: white;
}

.user-settings {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 72px;
  background: var(--bg-tertiary);
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.settings-modal {
  display: none;
  position: fixed;
  bottom: 80px;
  left: 80px;
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 8px;
  z-index: 1000;
  min-width: 300px;
}

.theme-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  cursor: pointer;
}

.theme-toggle:hover {
  background: rgba(79, 84, 92, 0.16);
  border-radius: 4px;
}

.light-theme {
  --bg-primary: #ffffff;
  --bg-secondary: #f2f3f5;
  --bg-tertiary: #e3e5e8;
  --text-primary: #2e3338;
  --text-secondary: #747f8d;
}

.store-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 8px;
  z-index: 1000;
  min-width: 300px;
  max-height: 80vh; 
  overflow-y: auto;  
}

.store-items {
  display: grid;
  gap: 16px;
  margin-top: 16px;
}

.store-item {
  background: var(--bg-primary);
  padding: 16px;
  border-radius: 8px;
}

.store-btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}

.store-btn:hover {
  opacity: 0.9;
}

.justbucks-display {
  margin-top: 20px;
  padding: 10px;
  background: var(--bg-primary);
  border-radius: 5px;
  text-align: center;
  font-size: 1.2em;
  color: var(--accent);
}

.replied-message {
  background: var(--bg-secondary);
  padding: 8px;
  border-left: 4px solid var(--accent);
  margin-bottom: 8px;
}

.replied-username {
  font-weight: bold;
  color: var(--accent);
}

.replied-text {
  color: var(--text-secondary);
}

.message-text a {
  color: var(--accent);
  text-decoration: none;
  transition: text-decoration 0.2s;
}

.message-text a:hover {
  text-decoration: underline;
}

.message-text a:visited {
  color: var(--accent);
  opacity: 0.8;
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr !important; /* Force single column */
    height: 100vh;
    overflow: hidden;
  }

  .servers {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60px;
    padding: 10px !important;
    flex-direction: row;
    justify-content: flex-start;
    z-index: 100;
    border-top: 1px solid rgba(79, 84, 92, 0.48);
    overflow-x: auto;
    overflow-y: hidden;
    margin: 0;
    background: var(--bg-tertiary);
  }

  .channels {
    display: none; /* Hidden by default on mobile */
    position: fixed;
    top: 50px;
    left: 0;
    width: 240px;
    height: calc(100vh - 110px);
    z-index: 90;
    background: var(--bg-secondary);
  }

  .chat {
    grid-column: 1;
    padding-top: 50px;
    padding-bottom: 120px;
    height: 100vh;
  }

  .messages {
    height: calc(100vh - 170px);
    padding-bottom: 0;
  }

  .input-area {
    left: 0;
    right: 0;
    bottom: 60px;
    padding: 10px;
  }

  .mobile-nav {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px;
    background: var(--bg-tertiary);
    z-index: 95;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    border-bottom: 1px solid rgba(79, 84, 92, 0.48);
  }

  .server-icon {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
    margin: 0 5px;
  }

  .user-settings {
    display: none; /* Hide settings on mobile */
  }

  /* Fix modal positioning for mobile */
  .settings-modal,
  .server-modal,
  .store-modal {
    width: 90%;
    max-width: 320px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
}

.mobile-nav {
  display: none;
}
</style>
</head>
<body>

<div class="container">
  <div class="mobile-nav">
    <button class="mobile-nav-btn" id="toggleChannels">☰</button>
    <span>JustCord</span>
  </div>

  <div class="servers" id="servers">
    <div class="server-icon active" data-server="main">JC</div>
    <div class="server-icon add" id="addServer">+</div>
  </div>

  <div class="channels" id="onlineUsers" style="background: var(--bg-secondary);">
    <h3>Online — 0</h3>
    <!-- Online users will be populated here -->
  </div>

  <div class="chat">
    <div class="messages" id="messages">
      <!-- Messages will be populated here -->
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <button class="upload-btn" id="uploadBtn">+</button>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
        <input type="text" class="message-input" id="messageInput" placeholder="Send a message..." />
      </div>
    </div>
  </div>
</div>

<div class="user-settings">
  <div class="server-icon" id="userSettingsBtn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zM6 12a6 6 0 1 1 12 0 6 6 0 0 1-12 0z"/>
    </svg>
  </div>
</div>

<div class="settings-modal" id="settingsModal">
  <h3>User Settings</h3>
  <div class="justbucks-display">
    <span id="justbucksDisplay">JustBucks: 0</span>
  </div>
  <div class="theme-toggle">
    <input type="checkbox" id="themeToggle">
    <label for="themeToggle">Light Mode</label>
  </div>
  <div class="store-toggle">
    Store
  </div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="server-modal" id="serverModal">
  <h3>Create a New Server</h3>
  <div class="preview-icon" id="serverIconPreview">
    Click to upload icon
  </div>
  <p class="upload-hint">Click icon to upload custom image</p>
  <input type="file" id="serverIconInput" accept="image/*" style="display: none">
  <input type="text" class="modal-input" id="serverName" placeholder="Server Name">
  <div class="modal-buttons">
    <button class="modal-button cancel" id="cancelServer">Cancel</button>
    <button class="modal-button create" id="createServer">Create</button>
  </div>
</div>

<div class="store-modal" id="storeModal">
  <h3>JustCord Store</h3>
  <div class="store-items">
    <div class="store-item">
      <h4>Premium Colors</h4>
      <p>Unlock custom username colors</p>
      <button class="store-btn" data-item="colors" data-price="100">100 JustBucks</button>
    </div>
    <div class="store-item">
      <h4>Custom Emotes</h4>
      <p>Add special emotes to your messages</p>
      <button class="store-btn" data-item="emotes" data-price="60">60 JustBucks</button>
    </div>
    <div class="store-item">
      <h4>Animated Avatar</h4>
      <p>Make your avatar animated</p>
      <button class="store-btn" data-item="animated" data-price="200">200 JustBucks</button>
    </div>
  </div>
</div>

<script>
function sanitizeString(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function isMobileDevice() {
  const isTouchDevice = (
    'ontouchstart' in window || 
    navigator.maxTouchPoints > 0
  );
  
  const isMobileScreen = window.innerWidth <= 768;
  
  const isMobileUserAgent = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  return isMobileScreen && (isTouchDevice || isMobileUserAgent);
}

const JUSTAI_AVATAR_URL = 'https://i.imgur.com/4M7IWwP.png'; // Replace with a valid image URL for JustAI's avatar
function showJustAiTyping() {
  const messagesContainer = document.getElementById('messages');
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'message justai typing';
  typingIndicator.dataset.temp = 'justai-typing';

  typingIndicator.innerHTML = `
    <img class="avatar" src="${JUSTAI_AVATAR_URL}" alt="JustAI avatar">
    <div class="message-content">
      <div class="message-header">
        <span class="username">JustAI</span>
        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
      </div>
      <div class="message-text"><em>JustAI is typing...</em></div>
    </div>
  `;

  messagesContainer.appendChild(typingIndicator);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeJustAiTyping() {
  const typingIndicator = document.querySelector('.message.justai.typing[data-temp="justai-typing"]');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

async function getJustAiResponse(question) {
  try {
    const response = await fetch('/api/chatgpt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ question })
    });

    if (response.ok) {
      const data = await response.json();
      return data.answer;
    } else {
      console.error('Error fetching JustAI response:', response.statusText);
      return "Sorry, I'm having trouble responding right now.";
    }
  } catch (error) {
    console.error('Error getting JustAI response:', error);
    return "Sorry, I'm having trouble responding right now.";
  }
}

const room = new WebsimSocket();
let currentServer = 'main';
let currentChannel = 'general';
let replyingTo = null;

async function loadServers() {
  const servers = await room.store.get('servers') || { 'main': 'JustCord' };

  updateServerList(servers);
}

function updateServerList(servers) {
  const serversContainer = document.getElementById('servers');
  const addServerBtn = document.getElementById('addServer');
  
  Array.from(serversContainer.children).forEach(child => {
    if (!child.classList.contains('add')) {
      child.remove();
    }
  });

  // Add main JC server first
  const mainServer = document.createElement('div');
  mainServer.className = 'server-icon';
  mainServer.textContent = 'JC';
  mainServer.dataset.server = 'main';
  serversContainer.insertBefore(mainServer, addServerBtn);
  attachServerClickHandler(mainServer);

  // Add other servers
  Object.entries(servers).forEach(([serverId, serverData]) => {
    if (serverId !== 'main') {
      const serverIcon = document.createElement('div');
      serverIcon.className = 'server-icon';
      
      if (typeof serverData === 'object' && serverData.iconUrl) {
        serverIcon.classList.add('custom-icon');
        serverIcon.style.backgroundImage = `url(${serverData.iconUrl})`;
      } else {
        const serverName = typeof serverData === 'object' ? serverData.name : serverData;
        serverIcon.textContent = serverName.substring(0, 2).toUpperCase();
      }
      
      serverIcon.dataset.server = serverId;
      serversContainer.insertBefore(serverIcon, addServerBtn);
      attachServerClickHandler(serverIcon);
    }
  });

  // Set the main server as active by default if no server is selected
  if (!currentServer || currentServer === 'main') {
    const mainServerIcon = serversContainer.querySelector('[data-server="main"]');
    if (mainServerIcon) {
      mainServerIcon.classList.add('active');
    }
  }
}

async function createMessageTable() {
  const query = `CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY,
    username TEXT,
    avatar TEXT,
    message TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    server TEXT,
    channel TEXT,
    reply_to INTEGER REFERENCES messages(id)
  )`;
  await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
}

function attachServerClickHandler(serverElement) {
  serverElement.addEventListener('click', () => {
      document.querySelectorAll('.server-icon').forEach(s => s.classList.remove('active')); 

    serverElement.classList.add('active');
    
    currentServer = serverElement.dataset.server;
    document.getElementById('messages').innerHTML = '';
    startMessagePolling();
  });
}

function addMessage(username, avatar, message, messageId, replyToMessageId, replyToUsername = '', replyToMessageContent = '') {
  const messagesContainer = document.getElementById('messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  if (username.toLowerCase() === 'justai') {
    messageDiv.classList.add('justai');
  }
  messageDiv.dataset.messageId = messageId;

  username = sanitizeString(username);
  avatar = sanitizeString(avatar);
  message = sanitizeString(message);

  let messageContent;
  if (message.startsWith('http') && (message.endsWith('.png') || message.endsWith('.jpg') || message.endsWith('.gif') || message.endsWith('.jpeg'))) {
      messageContent = `<img src="${message}" alt="Shared image" style="max-width: 300px; max-height: 300px;">`; 

  } else if (message.startsWith('http') && message.endsWith('.mp4')) {
    messageContent = `<video controls style="max-width: 300px;"><source src="${message}" type="video/mp4"></video>`;
  } else {
    const urlRegex = /(https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&//=]*))/g;
    messageContent = message.replace(urlRegex, (url) => {
      return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">${url}</a>`;
    });
  }

  let replyContent = '';
  if (replyToMessageId) {
    replyContent = `
      <div class="replied-message">
        <span class="replied-username">${replyToUsername}</span>
        <div class="replied-text">${replyToMessageContent}</div>
      </div>
    `;
  }

  const devTag = username === 'grog' ? ' <strong>(DEV)</strong>' : '';
  const replyButton = `
      <button class="reply-btn" onclick="replyToMessage(${messageId}, '${encodeURIComponent(username)}', '${encodeURIComponent(message)}')">
      <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
        <path d="M10 9V5l-7 7 7 7v-4h4v-6z"/>
      </svg>
    </button>
  `;
  const deleteButton = username === room.party.client.username ? 
    `<button class="delete-btn" onclick="deleteMessage(${messageId})">
      <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
        <path d="M16 9v10H8V9h8m-1.5-6H9.5L8 5H5v2h14V5h-3l-1.5-2z"/>
      </svg>
    </button>` : '';

  const banButton = room.party.client.username === 'grog' ? 
    `<button class="delete-btn" style="background: var(--red)" onclick="banUser('${username}')">
      Ban User
    </button>` : '';

  messageDiv.innerHTML = `
    <img class="avatar" src="${avatar}" alt="User avatar">
    <div class="message-content">
      <div class="message-header">
        <span class="username">${username}${devTag}</span>
        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
      </div>
      ${replyContent}
      <div class="message-text">${messageContent}</div>
      <div class="message-actions">
        ${replyButton}
        ${deleteButton}
        ${banButton}
      </div>
    </div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function deleteMessage(messageId) {
  try {
    const query = `SELECT username FROM messages WHERE id = ${messageId}`;
    const response = await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
    const [message] = await response.json();
    
    if (message && message.username === room.party.client.username) {
      const deleteQuery = `DELETE FROM messages WHERE id = ${messageId}`;
      await fetch('/api/v1/sql/?' + new URLSearchParams({sql: deleteQuery}));
      
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.remove();
      }
      
      room.send({
        type: 'messageDeleted',
        messageId: messageId
      });
    }
  } catch (error) {
    console.error('Error deleting message:', error);
  }
}

async function banUser(username) {
  if (room.party.client.username !== 'grog') {
    console.log('Only the developer can ban users');
    return;
  }

  try {
    room.store.update({
      id: 'banned_users',
      dependencies: { username },
      updateFunction: (bannedUsers = []) => {
        if (!Array.isArray(bannedUsers)) {
          bannedUsers = [];
        }
        if (!bannedUsers.includes(username)) {
          bannedUsers.push(username);
        }
        return bannedUsers;
      }
    });

    room.send({
      type: 'userBanned',
      bannedUsername: username
    });

  } catch (error) {
    console.error('Error banning user:', error);
  }
}

function initializeJustBucks() {
  room.store.get('justbucks_balances').then((balances) => {
    if (!balances) {
      balances = {};
    }
    const username = room.party.client.username;
    if (!balances[username]) {
      balances[username] = 0;
      room.store.update({
        id: 'justbucks_balances',
        dependencies: { username, balances },
        updateFunction: (storeBalances = {}) => {
          storeBalances[username] = balances[username];
          return storeBalances;
        }
      });
    }
  });

  setInterval(() => {
    const username = room.party.client.username;
    room.store.update({
      id: 'justbucks_balances',
      dependencies: { username },
      updateFunction: (storeBalances = {}) => {
        if (!storeBalances[username]) {
          storeBalances[username] = 0;
        }
        storeBalances[username] += 5;
        return storeBalances;
      }
    });
  }, 60000); 
  
}

function updateJustBucksDisplay() {
  const username = room.party.client.username;
  room.store.get('justbucks_balances').then((balances) => {
    if (balances && balances[username] !== undefined) {
      const balanceDisplay = document.getElementById('justbucksDisplay');
      if (balanceDisplay) {
        balanceDisplay.textContent = 'JustBucks: ' + balances[username];
      }
    }
  });
}

async function init() {
  const username = room.party.client.username;
  const bannedUsers = await room.store.get('banned_users') || [];
  
  if (Array.isArray(bannedUsers) && bannedUsers.includes(username)) {
    document.body.innerHTML = '<h1 style="color: var(--red); text-align: center; margin-top: 40px;">You have been banned from this server.</h1>';
    return;
  }

  if (localStorage.getItem('banned') === 'true') {
    document.body.innerHTML = '<h1>You have been banned from this server.</h1>';
    return;
  }

  const isMobile = isMobileDevice();
  if (isMobile) {
    document.body.classList.add('mobile');
    
    const messages = document.querySelector('.messages');
    if (messages) {
      messages.style.paddingTop = '60px';
    }
    
    const mobileNav = document.querySelector('.mobile-nav');
    if (mobileNav) {
      mobileNav.style.display = 'flex';
    }

    const toggleChannels = document.getElementById('toggleChannels');
    const channels = document.getElementById('onlineUsers');
    if (toggleChannels && channels) {
      toggleChannels.addEventListener('click', () => {
        channels.style.display = channels.style.display === 'none' ? 'block' : 'none';
      });
      channels.style.display = 'none';
    }
  }

  await createMessageTable();
  setupEventListeners();
  setupServerCreation(); 
  setupUserSettings();
  initializeJustBucks();
  await loadServers();
  
  room.onRecordChanged = (id) => {
    if (id === 'servers') {
      loadServers();
    } 
    if (id === 'justbucks_balances') {
      updateJustBucksDisplay();
    }
  };

  startMessagePolling();
}

function setupEventListeners() {
  const messageInput = document.getElementById('messageInput');
  
  messageInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter' && messageInput.value.trim()) {
      let message = messageInput.value.trim();
      messageInput.value = '';

      const replyTo = replyingTo ? replyingTo.messageId : null;
      const replyToUsername = replyingTo ? replyingTo.username : null;
      const replyToMessageContent = replyingTo ? replyingTo.messageContent : null;
      cancelReply();

      const sanitizedMsg = message.replace(/'/g, "''");
      const currentServerSafe = currentServer.replace(/'/g, "''");

      const query = `INSERT INTO messages (username, avatar, message, server, channel, reply_to) 
        VALUES ('${room.party.client.username.replace(/'/g, "''")}', 
                '${room.party.client.avatarUrl.replace(/'/g, "''")}', 
                '${sanitizedMsg}', 
                '${currentServerSafe}', 
                '${currentChannel.replace(/'/g, "''")}',
                ${replyTo || 'NULL'}) RETURNING id`;

      const response = await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
      const [result] = await response.json();
      const messageId = result.id;

      room.send({
        type: 'newMessage',
        message: sanitizedMsg,
        messageUsername: room.party.client.username,
        messageAvatar: room.party.client.avatarUrl,
        server: currentServer,
        channel: currentChannel,
        messageId: messageId,
        replyTo: replyTo,
        replyToUsername: replyToUsername,
        replyToMessageContent: replyToMessageContent
      });

      if (message.toLowerCase().includes('@justai')) {
        showJustAiTyping();

        getJustAiResponse(message)
          .then(async (aiResponse) => {
            removeJustAiTyping();

            const aiUsername = 'JustAI';
            const aiAvatar = JUSTAI_AVATAR_URL;
            const sanitizedAiResponse = aiResponse.replace(/'/g, "''");

            const aiMessageQuery = `INSERT INTO messages (username, avatar, message, server, channel) 
              VALUES ('${aiUsername.replace(/'/g, "''")}', 
                      '${aiAvatar.replace(/'/g, "''")}', 
                      '${sanitizedAiResponse}', 
                      '${currentServer.replace(/'/g, "''")}', 
                      '${currentChannel.replace(/'/g, "''")}') RETURNING id`;
            const aiResponseFetch = await fetch('/api/v1/sql/?' + new URLSearchParams({sql: aiMessageQuery}));
            const [aiResult] = await aiResponseFetch.json();
            const aiMessageId = aiResult.id;

            room.send({
              type: 'newMessage',
              message: aiResponse,
              messageUsername: aiUsername,
              messageAvatar: aiAvatar,
              server: currentServer,
              channel: currentChannel,
              messageId: aiMessageId,
              replyTo: null,
              replyToUsername: null,
              replyToMessageContent: null
            });
          })
          .catch((error) => {
            removeJustAiTyping();
            console.error('Error handling JustAI response:', error);
          });
      }
    }
  });
  
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');

  uploadBtn.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      try {
        const url = await websim.upload(file);
        
        const query = `INSERT INTO messages (username, avatar, message, server, channel) 
          VALUES ('${room.party.client.username.replace(/'/g, "''")}', 
                  '${room.party.client.avatarUrl.replace(/'/g, "''")}', 
                  '${url}', 
                  '${currentServer.replace(/'/g, "''")}', 
                  '${currentChannel.replace(/'/g, "''")}') RETURNING id`;
                  
        const response = await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
        const [result] = await response.json();
        const messageId = result.id;
        
        room.send({
          type: 'newMessage',
          message: url,
          messageUsername: room.party.client.username,
          messageAvatar: room.party.client.avatarUrl,
          server: currentServer,
          channel: currentChannel,
          messageId: messageId,
          replyTo: null,
          replyToUsername: null, 
          replyToMessageContent: null
        });

        fileInput.value = ''; 
      } catch (error) {
        console.error('Error uploading file:', error);
      }
    }
  });
  
  room.onmessage = (event) => {
    const data = event.data;
    if (data.type === 'newMessage') {
      if (data.server === currentServer) {
        addMessage(
          data.messageUsername, 
          data.messageAvatar, 
          data.message, 
          data.messageId, 
          data.replyTo, 
          data.replyToUsername, 
          data.replyToMessageContent
        );
      }
    } else if (data.type === 'messageDeleted') {
      const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
      if (messageElement) {
        messageElement.remove();
      }
    } else if (data.type === 'userBanned') {
      if (data.bannedUsername === room.party.client.username) {
        localStorage.setItem('banned', 'true');
        document.body.innerHTML = '<h1 style="color: var(--red); text-align: center; margin-top: 40px;">You have been banned from this server.</h1>';
      }
    }
  };
  
  room.onPeersChanged = (peers) => {
    updateOnlineUsers(peers);
  };
}

function setupServerCreation() {
  const addServerBtn = document.getElementById('addServer');
  const modal = document.getElementById('serverModal');
  const overlay = document.getElementById('modalOverlay');
  const cancelBtn = document.getElementById('cancelServer');
  const createBtn = document.getElementById('createServer');
  const serverNameInput = document.getElementById('serverName');
  const serverIconInput = document.getElementById('serverIconInput');
  const serverIconPreview = document.getElementById('serverIconPreview');
  
  let uploadedIconUrl = null;
  
  addServerBtn.addEventListener('click', () => {
    modal.style.display = 'block';
    overlay.style.display = 'block';
    uploadedIconUrl = null;
    serverIconPreview.style.backgroundImage = '';
    serverIconPreview.textContent = 'Click to upload icon';
  });
  
  serverIconPreview.addEventListener('click', () => {
    serverIconInput.click();
  });
  
  serverIconInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      try {
        uploadedIconUrl = await websim.upload(file);
        serverIconPreview.style.backgroundImage = `url(${uploadedIconUrl})`;
        serverIconPreview.textContent = '';
        serverIconPreview.style.backgroundSize = 'cover';
      } catch (error) {
        console.error('Error uploading server icon:', error);
      }
    }
  });
  
  cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none';
    overlay.style.display = 'none';
    serverNameInput.value = '';
    uploadedIconUrl = null;
  });
  
  createBtn.addEventListener('click', async () => {
    const serverName = serverNameInput.value.trim();
    if (serverName) {
      const serverId = serverName.toLowerCase().replace(/\s+/g, '-');
      
      const serversContainer = document.getElementById('servers');
      const serverIcon = document.createElement('div');
      serverIcon.className = 'server-icon';
      
      if (uploadedIconUrl) {
        serverIcon.classList.add('custom-icon');
        serverIcon.style.backgroundImage = `url(${uploadedIconUrl})`;
      } else {
        serverIcon.textContent = serverName.substring(0, 2).toUpperCase();
      }
      
      serverIcon.dataset.server = serverId;
      
      serversContainer.insertBefore(serverIcon, addServerBtn);
      attachServerClickHandler(serverIcon);
      
      room.store.update({
        id: 'servers',
        dependencies: { serverId, serverName, uploadedIconUrl },
        updateFunction: (servers = {}) => {
          servers[serverId] = {
            name: serverName,
            iconUrl: uploadedIconUrl
          };
          return servers;
        }
      });
      
      modal.style.display = 'none';
      overlay.style.display = 'none';
      serverNameInput.value = '';
      uploadedIconUrl = null;
    }
  });
}

async function startMessagePolling() {
  try {
    if (!currentServer) {
      console.error('Server not defined');
      return;
    }

    const safeServer = currentServer.replace(/'/g, "''");
    
    const query = `
      SELECT m.*
      FROM messages m
      WHERE m.server = '${safeServer}' 
      ORDER BY m.timestamp DESC 
      LIMIT 50`;

    const response = await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
    const messages = await response.json();
    
    const messagesContainer = document.getElementById('messages');
    if (!messagesContainer) {
      console.error('Messages container not found');
      return;
    }
    
    messagesContainer.innerHTML = '';
    
    if (Array.isArray(messages)) {
      messages.reverse().forEach(msg => {
        if (msg && msg.username && msg.avatar) {
          addMessage(
            msg.username, 
            msg.avatar, 
            msg.message, 
            msg.id, 
            null
          );
        }
      });
    }
  } catch (error) {
    console.error('Error polling messages:', error);
  }
}

function updateOnlineUsers(peers) {
  const onlineUsersContainer = document.getElementById('onlineUsers');
  onlineUsersContainer.innerHTML = '<h3>Online — ' + Object.keys(peers).length + '</h3>';
  
  Object.entries(peers).forEach(([clientId, {username, avatarUrl}]) => {
    const userElement = document.createElement('div');
    userElement.className = 'online-user';
    
    username = sanitizeString(username);
    avatarUrl = sanitizeString(avatarUrl);
    const devTag = username === 'grog' ? ' <strong>(DEV)</strong>' : '';
    
    userElement.innerHTML = `
      <div class="status" title="Online"></div>
      <img class="avatar" src="${avatarUrl}" alt="User avatar">
      <span class="username">${username}${devTag}</span>
    `;
    
    onlineUsersContainer.appendChild(userElement);
  });
}

function setupUserSettings() {
  const settingsBtn = document.getElementById('userSettingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const themeToggle = document.getElementById('themeToggle');

  const storeBtn = document.createElement('div');
  storeBtn.className = 'theme-toggle';
  storeBtn.innerHTML = 'Store';
  settingsModal.appendChild(storeBtn);

  const storeModal = document.getElementById('storeModal');

  settingsBtn.addEventListener('click', () => {
    settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
  });

  themeToggle.addEventListener('change', () => {
    const newTheme = themeToggle.checked ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    document.body.classList.toggle('light-theme', newTheme === 'light');
  });

  storeBtn.addEventListener('click', () => {
    storeModal.style.display = 'block';
    settingsModal.style.display = 'none';
  });

  document.addEventListener('click', (e) => {
    if (!settingsModal.contains(e.target) && !settingsBtn.contains(e.target)) {
      settingsModal.style.display = 'none';
    }
    if (!storeModal.contains(e.target) && !storeBtn.contains(e.target)) {
      storeModal.style.display = 'none';
    }
  });
}

function replyToMessage(messageId, encodedUsername, encodedMessageContent) {
  const username = decodeURIComponent(encodedUsername);
  const messageContent = decodeURIComponent(encodedMessageContent);
  replyingTo = { messageId, username, messageContent };
  const inputArea = document.querySelector('.input-area');
  let replyPreview = document.getElementById('replyPreview'); 

  if (!replyPreview) {
    replyPreview = document.createElement('div');
    replyPreview.id = 'replyPreview';
    replyPreview.innerHTML = `
      <div class="reply-preview">
        <span>Replying to <strong>${username}</strong>: ${messageContent.substring(0, 50)}</span>
        <button onclick="cancelReply()" class="cancel-reply-btn">✖️</button>
      </div>
    `;
    inputArea.insertBefore(replyPreview, inputArea.firstChild);
  } else {
    replyPreview.querySelector('span').innerHTML = `Replying to <strong>${username}</strong>: ${messageContent.substring(0, 50)}`;
  }
}

function cancelReply() {
  replyingTo = null;
  const replyPreview = document.getElementById('replyPreview');
  if (replyPreview) {
    replyPreview.remove();
  }
}

window.addEventListener('resize', () => {
  const isMobile = isMobileDevice();
  document.body.classList.toggle('mobile', isMobile);
  
  if (isMobile) {
    const messages = document.querySelector('.messages');
    if (messages) {
      messages.style.paddingTop = '60px';
    }
    const mobileNav = document.querySelector('.mobile-nav');
    if (mobileNav) {
      mobileNav.style.display = 'flex';
    }
  } else {
    const messages = document.querySelector('.messages');
    if (messages) {
      messages.style.paddingTop = '0';
    }
    const mobileNav = document.querySelector('.mobile-nav');
    if (mobileNav) {
      mobileNav.style.display = 'none';
    }
    const channels = document.getElementById('onlineUsers');
    if (channels) {
      channels.style.display = 'block';
    }
  }
});

(async () => {
  try {
    await init();
  } catch(err) {
    console.error('Error during initialization:', err);
  }
})();
</script>

</body></html>
