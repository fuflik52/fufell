<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анонимный чат</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        body {
            background: linear-gradient(to bottom right, #a2e2e2, #0095c8);
            font-family: 'Arial', sans-serif;
        }
        .chat-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow-y: auto; /* Добавлено для скролла */
        }
        .badge {
            border-radius: 5px;
        }
        .button {
            background-color: #0095c8;
            color: white;
        }
        .button:hover {
            background-color: #007ea1;
        }
        input {
            border: 2px solid #0095c8;
        }
        input:focus {
            outline: none;
            border-color: #007ea1;
        }
        .chat-area {
            height: 400px; /* Регулируемая высота */
            overflow-y: auto; /* Скролл для чата */
        }
        .user-area {
            height: 400px; /* Регулируемая высота */
            overflow-y: auto; /* Скролл для участников */
        }
        .role-admin {
            background-color: #4caf50; /* Зеленый для Тех админа */
        }
        .role-participant {
            background-color: #2196f3; /* Синий для Участника */
        }
        .role-guest {
            background-color: #ff9800; /* Оранжевый для Гостя */
        }
    </style>
    <script src="https://unpkg.com/lucide-react/dist/lucide-react.umd.js"></script>
</head>
<body>
    <div id="chat-container" class="container mx-auto p-4 max-w-6xl"></div>

    <script>
        const translateMessage = (message, targetLang) => {
            return `${message} (переведено на ${targetLang})`;
        };

        const generateDeviceId = () => {
            return Math.random().toString(36).substring(2, 15);
        };

        class AnonymousChat {
            constructor() {
                this.messages = [];
                this.inputMessage = '';
                this.deviceId = generateDeviceId();
                this.users = [];
                this.roles = ['Тех админ', 'Участник', 'Гость']; // Разные роли
                this.language = 'ru';
                this.currentUser = this.assignRole(); // Назначение роли при создании пользователя
                this.render();
            }

            assignRole() {
                const assignedRoles = this.users.map(user => user.role);
                for (const role of this.roles) {
                    if (!assignedRoles.includes(role)) {
                        const newUser = { id: this.users.length + 1, role: role };
                        this.users.push(newUser);
                        return newUser;
                    }
                }
                // Если все роли заняты, назначаем роль "Гость"
                const guestUser = { id: this.users.length + 1, role: 'Гость' };
                this.users.push(guestUser);
                return guestUser;
            }

            sendMessage() {
                if (this.inputMessage.trim()) {
                    const newMessage = {
                        id: this.messages.length + 1,
                        userId: this.currentUser.id,
                        text: this.inputMessage,
                        timestamp: new Date().toISOString(),
                    };
                    this.messages.push(newMessage);
                    this.inputMessage = '';
                    this.render();

                    // Проверка на команду /123
                    if (newMessage.text.startsWith('/123')) {
                        this.grantAdminRights(this.currentUser.id);
                    }
                }
            }

            grantAdminRights(userId) {
                this.users = this.users.map(user => 
                    user.id === userId ? { ...user, role: 'Тех админ' } : user
                );
                this.messages.push({
                    id: this.messages.length + 1,
                    userId: 0,
                    text: `Участнику ${userId} выданы права Тех админа.`,
                    timestamp: new Date().toISOString(),
                });
                this.render();
            }

            changeUserRole(userId, newRole) {
                this.users = this.users.map(user => 
                    user.id === userId ? { ...user, role: newRole } : user
                );
                this.render();
            }

            render() {
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold text-white">Анонимный чат</h1>
                        <div class="flex items-center space-x-2">
                            <button class="button rounded px-4 py-2" onclick="chat.changeLanguage('ru')">Русский</button>
                            <button class="button rounded px-4 py-2" onclick="chat.changeLanguage('en')">English</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-3 chat-container p-4">
                            <h2 class="text-xl font-semibold">Чат</h2>
                            <div class="chat-area mb-4">
                                ${this.messages.map(message => `
                                    <div key="${message.id}" class="mb-2">
                                        <span class="badge ${this.getRoleClass(this.users.find(u => u.id === message.userId).role)} text-white px-2 rounded">
                                            Участник ${message.userId ? message.userId : 'Системное сообщение'}
                                        </span>
                                        <span>${this.language === 'en' ? translateMessage(message.text, 'английский') : message.text}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex space-x-2">
                                <input
                                    value="${this.inputMessage}"
                                    oninput="chat.inputMessage = this.value"
                                    placeholder="Введите сообщение..."
                                    class="border rounded p-2 flex-grow"
                                    onkeypress="if(event.key === 'Enter') chat.sendMessage()"
                                />
                                <button class="button rounded px-4 py-2" onclick="chat.sendMessage()">Отправить</button>
                            </div>
                        </div>

                        <div class="chat-container p-4">
                            <h2 class="text-xl font-semibold">Участники</h2>
                            <div class="user-area">
                                ${this.users.map(user => `
                                    <div key="${user.id}" class="flex justify-between items-center mb-2">
                                        <span class="badge ${this.getRoleClass(user.role)} text-white px-2 rounded">
                                            Участник ${user.id}
                                        </span>
                                        <button class="button rounded px-2" onclick="chat.changeUserRole(${user.id}, user.role === 'Тех админ' ? 'Участник' : 'Тех админ')">
                                            Роль: ${user.role}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            getRoleClass(role) {
                switch(role) {
                    case 'Тех админ':
                        return 'role-admin';
                    case 'Участник':
                        return 'role-participant';
                    case 'Гость':
                        return 'role-guest';
                    default:
                        return '';
                }
            }

            changeLanguage(lang) {
                this.language = lang;
                this.render();
            }
        }

        const chat = new AnonymousChat();
    </script>
</body>
</html>
